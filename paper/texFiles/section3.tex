%
\section{Finite Element Formulation}
\label{formulation}
In this section, we introduce the finite element formulation to solve static problems for hyperelastic materials. Starting from the basic principles, we will construct the equations to be solved using the stress tensor we derived in Section \ref{general}. Furthermore, we will show how to linearize the nonlinear equations in order to solve them. The final linear equation system is given in matrix form which is ready to be solved with proper matrix solver. In particular, the mixed formulation will be discussed in detail.

%
\subsection{Principle of Virtual Work} \label{PVW}
The variational approach is the cornerstone for finite element methods. The most fundamental variational principle that origins from Newton's law is the principle of virtual work. Neglecting the kinematic term, it can be written as
\begin{subequations} \label{virtualwork}
\begin{align}
\delta{W_{int}} &= \delta{W_{ext}} \label{basic} \\
\delta W_{int}(\bold{u}, \delta\bold{u}) &= \int_\Omega \boldsymbol\sigma : \delta\bold{e}dV = \int_{\Omega_{0}}\bold{S} : \delta\bold{E}dV \label{Wint} \\
\delta W_{ext}(\bold{u}, \delta\bold{u}) &= \int_\Omega\bold{b}\cdot\delta\bold{u}dV +  \int_{\partial\Omega}\overline{\bold{t}}\cdot\delta{\bold{u}}dS = \int_{\Omega_0}\bold{B}\cdot\delta\bold{u}dV +  \int_{\partial{\Omega_0}}\overline{\bold{T}}\cdot\delta{\bold{u}}dS \label{Wext1}
\end{align}
The internal work is done by Cauchy stress $\boldsymbol\sigma$ along the virtual Euler-Almansi strain $\delta\bold{e}$ about region $\Omega$ and the external work is done by the body force $\bold{b}$ and the surface traction $\overline{\bold{t}}$, along the virtual displacement $\delta{\bold{u}}$ about region $\Omega$ and its boundary surface $\partial\Omega$ respectively. They are assumed be mapped to the reference configuration. 

If the external loading is given as fixed traction in reference configuration, the virtual external work is constant. An example for this type of loading is a tension test where the external force with respect to reference configuration is given as a constant. Another type of loading, which is more frequently encountered in biomechanics is the fixed pressure loading.
In this case, the pressure on the current boundary surface is constant, i.e. $\overline{\bold{t}} = \boldsymbol{\sigma{n}} = p_0\bold{n}$ where $p_0$ is a given constant, $\bold{n}$ is the unit normal vector of the current surface. The external virtual work done by the constant pressure $p_0$ along the virtual displacement $\delta{\bold{u}}$ is defined by
\begin{align} 
\delta{W_{ext}}(\bold{u}, \delta{\bold{u}}) &= p_0\int_{\partial\Omega} \bold{n}\cdot\delta{\bold{u}}dS \label{Wext2}
\end{align}
\end{subequations}



%
\subsection{Principle of Stationary Potential Energy}
Assuming the mechanical system is conservative, then there exists an energy functional $\Pi$ for both the stresses and the loadings whose sum is constant. In the displacement-based formulation, $\Pi$ is a function of displacement $\bold{u}$ only, and it leads to the same equations as the virtual work balance. While in the displacement/pressure mixed formulation, $\Pi$ is a function of both displacement $\bold{u}$ and pressure $p$. It treats pressure as an independent variable and has advantages of avoiding locking and ameliorate the ill-condition of the stiffness matrix in certain situation.

In displacement-based formulation, the potential energy is expressed as:
\begin{subequations}
\begin{align}
\Pi(\bold{u}) &= \Pi_{int}(\bold{u}) + \Pi_{ext}(\bold{u}) \\
\Pi_{int}(\bold{u}) &= \int_{\Omega_{0}}\Psi(\bold{F}(\bold{u}))dV  \label{pint} \\
\Pi_{ext}(\bold{u}) &=  - \int_{\Omega_0}\bold{B}\cdot\bold{u}dV -  \int_{\partial{\Omega_0}}\overline{\bold{T}}\cdot{\bold{u}}dS
\label{pext} 
\end{align}
\end{subequations}

Our objective is to find the state of equilibrium for which the system is stationary. In displacement-based formulation, this means the directional derivative with respect to the displacement $\bold{u}$ to vanish in all directions $\delta{\bold{u}}$.
\begin{equation} \label{equilibrium}
D_{\delta\bold{u}}\Pi(\bold{u}) = D_{\delta\bold{u}}\Pi_{int}(\bold{u}) + D_{\delta\bold{u}}\Pi_{ext}(\bold{u}) = 0
\end{equation} 
In other words, we require the first variation of the total energy potential $\delta\Pi$ to vanish.
\begin{equation} \label{potential}
\delta\Pi(\bold{u}, \delta\bold{u}) =\delta\Pi_{int}(\bold{u}) + \delta\Pi_{ext}(\bold{u}) = 0
\end{equation}
Here we adopt the convention in \cite{Holzapfel} using $D_{\Delta{x}}f(x, y, \textit{etc.})$ to represent the directional derivative of $f$ as a function of $x, y, \textit{etc.}$ along the direction of $\Delta{x}$ where $x$, $y$, \textit{etc.} can be a scalar or a tensor of any other order. The directional derivative $D_{\Delta{x}}f(x, y, \textit{etc.})$ is equivalent to the first variation of functional $f$ with respect to $x$.
Equation \ref{equilibrium} or \ref{potential} is the equation we want to solve in the displacement-based formulation. It is easy to prove the equivalence between the principle of directional derivative of the potential energy and the virtual work:

\begin{equation}
D_{\delta\bold{u}}\Pi_{int}(\bold{u}) = \delta W_{int}(\bold{u}, \delta\bold{u}) \quad
D_{\delta\bold{u}}\Pi_{ext}(\bold{u}) = - \delta W_{ext}(\bold{u}, \delta\bold{u})
\end{equation}

In the mixed formulation, we have two independent variables, $\bold{u}$ and $p$. The state of equilibrium is with respect to both of them. Our objective equation becomes
\begin{equation} \label{target}
D_{\delta\bold{u}}\Pi(\bold{u}, p) = 0 \quad D_{\delta{p}}\Pi(\bold{u}, p) = 0
\end{equation}
To summarize, in displacement-based formulation, our goal is to find an equilibrium state for total potential energy with respect to $\bold{u}$; in mixed formulation, we need to find an equilibrium state with respect to both $\bold{u}$ and $p$. To solve these equations, we have to linearize them first. That is, to find the second variation of the potential energy.


%
\subsection{Linearization of the Principle of Stationary Potential Energy}
In displacement-based formulation, we want to solve Equation \ref{equilibrium}. Based on Equation \ref{Wint}, by means of differentiation, we have

\begin{equation} \label{Kint}
D^2_{\delta\bold{u}, \Delta\bold{u}}\Pi_{int}(\bold{u}) = D_{\Delta{\bold{u}}}\delta{W_{int}}(\bold{u}, \delta{\bold{u}}) = \int_{\Omega_0}(\nabla_{\bold{X}}\delta\bold{u} : \nabla_{\bold{X}}\Delta\bold{u}\bold{S} + \bold{F}^T\nabla_{\bold{X}}\delta{\bold{u}} : \mathbb{C} : \bold{F}^T \nabla_{\bold{X}}\Delta\bold{u})dV
\end{equation}
The first term in the integration is called the initial stress contribution since the $\bold{S}$ characterizes the initial stress at every increment. The second term is called material contribution because the $\mathbb{C}$ characterize the material response to the displacement.

As discussed in Section \ref{PVW}, for the first type of external loading as in Equation \ref{Wext1}, the external work is independent of the displacement. So the variation vanishes.

\begin{equation} \label{Kext}
D^2_{\delta\bold{u}, \Delta\bold{u}}\Pi_{ext}(\bold{u}) = - D_{\Delta{\bold{u}}}\delta{W_{ext}}(\bold{u}, \delta{\bold{u}}) = 0
\end{equation}
But for the second type of loading as in Equation \ref{Wext2}, the external work is changing with the current configuration due to the change of normal $\bold{n}$ and integration boundary $d\bold{s}$. 

Let $\bold{x}$ be an arbitrary point on the surface of a 3D element, $\xi$ and $\eta$ be the parent coordinates on that surface. $\Omega_{\xi}$ represents the parameter plane characterized by $\xi$ and $\eta$. Then the unit normal vector of that surface $\bold{n}$ as well as the infinite small area $ds$ can be expressed as

\begin{equation}
\bold{n} = \frac{  \frac{\partial{\bold{x}}}{\partial{\xi}} \times  \frac{\partial{\bold{x}}}{\partial{\eta}} }{\left| \frac{\partial{\bold{x}}}{\partial{\xi}} \times  \frac{\partial{\bold{x}}}{\partial{\eta}} \right|}
\end{equation}
\begin{equation}
ds = \left|\frac{\partial{\bold{x}}}{\partial{\xi}} \times  \frac{\partial{\bold{x}}}{\partial{\eta}}\right| d\xi{d\eta}
\end{equation}
With these two equations, we can express Equation \ref{Wext2} as
\begin{equation}
\delta{W_{ext}}(\bold{u}, \delta{\bold{u}}) = p\int_{\Omega_{\xi}}  \left(\frac{\partial{\bold{x}}}{\partial{\xi}} \times  \frac{\partial{\bold{x}}}{\partial{\eta}}\right) \cdot\delta{\bold{u}}d\xi{d\eta}
\end{equation}
The linearization is obtained by a straight-forward derivation with respect to $\Delta\bold{u}$. 
\begin{equation}  \label{Kext2}
D^2_{\delta\bold{u}, \Delta\bold{u}}\Pi_{ext}(\bold{u}) = - D_{\Delta{\bold{u}}}\delta{W_{ext}}(\bold{u}, \delta{\bold{u}}) = - p\int_{\Omega_{\xi}}  \left(\frac{\partial{\bold{x}}}{\partial{\eta}} \times \delta\bold{u}\right) \cdot\Delta{\bold{u}}_{,\xi} - 
\left(\frac{\partial{\bold{x}}}{\partial{\xi}} \times \delta\bold{u}\right) \cdot\Delta{\bold{u}}_{,\eta} d\xi{d\eta}
\end{equation}
With Equation \ref{Kint} and \ref{Kext} or \ref{Kext2} we are able to obtain the matrix form for displacement-based formulation.
\begin{equation} \label{matrix}
\left( D^2_{\delta\bold{u}, \Delta\bold{u}}\Pi_{int}(\bold{u}) + D^2_{\delta\bold{u}, \Delta\bold{u}}\Pi_{ext}(\bold{u})  \right) \Delta\bold{u} = D_{\delta\bold{u}}\Pi_{int}(\bold{u}) + D_{\delta\bold{u}}\Pi_{ext}(\bold{u})
\end{equation}
The terms in the parenthesis on the lefthand side is the tangent stiffness matrix, the righthand side is the residual of the system potential energy. $\Delta\bold{u}$ is the increment of displacement. 

To solve with the mixed formulation in Equation \ref{target}, linearization with respect to $\bold{u}$ and $p$ must be carried out. The incremented matrix form becomes

\begin{equation} \label{linear}
\begin{bmatrix}
D_{\delta\bold{u}, \Delta\bold{u}}^2 \Pi(\bold{u}, p)  && D_{\delta\bold{u}, \Delta{p}}^2 \Pi(\bold{u}, p)  \\ D_{\delta{p}, \Delta\bold{u}}^2 \Pi(\bold{u}, p)  && D_{\delta{p}, \Delta{p}}^2 \Pi(\bold{u}, p) 
\end{bmatrix}
\begin{bmatrix}
\Delta\bold{u} \\ \Delta{p}
\end{bmatrix}
= 
\begin{bmatrix}
D_{\delta\bold{u}}\Pi(\bold{u}, p) \\ D_{\delta{p}}\Pi(\bold{u}, p) 
\end{bmatrix}
\end{equation}
We inspect the righthand side first. For incompressible material, recall Equations \ref{energy_split} and \ref{Lagrange}, the energy potential is expressed as
\begin{equation} \label{split3}
\Pi_{int}(\bold{u}, p) = \int_{\Omega_0} \left[ p(J(\bold{u}) - 1) + \Psi_{iso}(\overline{\bold{C}}(\bold{u}))\right] dV
\end{equation}
Using the chain rule, it can be derived that
\begin{equation}\label{rhs1}
D_{\delta\bold{u}}\Pi(\bold{u}, p) = \int_{\Omega_0}\left( J(\bold{u})p\bold{C}^{-1}(\bold{u}) + 
2\frac{\partial{\Psi_{iso}(\overline{\bold{C}}(\bold{u}))}}{\partial{\bold{C}}}  \right) : \delta\bold{E}(\bold{u}) dV + D_{\delta\bold{u}}\Pi_{ext}(\bold{u})
\end{equation}
\begin{equation}\label{rhs2}
D_{\delta{p}}\Pi(\bold{u}, p) = \int_{\Omega_0} (J(\bold{u}) - 1 )\delta{p} dV
\end{equation}
For the left hand side, $D_{\delta\bold{u}, \Delta\bold{u}}^2 \Pi(\bold{u}, p)$ has already been derived in the last section as the sum of Equation \ref{Kint} and Equation \ref{Kext} or \ref{Kext2}, i.e.
\begin{equation} \label{lhs0}
D_{\delta\bold{u}, \Delta\bold{u}}^2 \Pi(\bold{u}, p) =  \int_{\Omega_0}(\nabla_{\bold{X}}\delta\bold{u} : \nabla_{\bold{X}}\Delta\bold{u}\bold{S} + \bold{F}^T\nabla_{\bold{X}}\delta{\bold{u}} : \mathbb{C} : \bold{F}^T \nabla_{\bold{X}}\Delta\bold{u})dV  \end{equation}
when pressure boundary condition is applied
\begin{equation} \label{lhs1}
\begin{split}
D_{\delta\bold{u}, \Delta\bold{u}}^2 \Pi(\bold{u}, p) 
&= \int_{\Omega_0}(\nabla_{\bold{X}}\delta\bold{u} : \nabla_{\bold{X}}\Delta\bold{u}\bold{S} + \bold{F}^T\nabla_{\bold{X}}\delta{\bold{u}} : \mathbb{C} : \bold{F}^T \nabla_{\bold{X}}\Delta\bold{u})dV  \\
&-  p\int_{\Omega_{\xi}}  \left(\frac{\partial{\bold{x}}}{\partial{\eta}} \times \delta\bold{u}\right) \cdot\Delta{\bold{u}}_{,\xi} - 
\left(\frac{\partial{\bold{x}}}{\partial{\xi}} \times \delta\bold{u}\right) \cdot\Delta{\bold{u}}_{,\eta} d\xi{d\eta}
\end{split}
\end{equation}
It is a little tricky but not complicated to obtain that
\begin{equation} \label{lhs2}
D_{\delta\bold{u}, \Delta{p}}^2 \Pi(\bold{u}, p) = \int_{\Omega_0} J(\bold{u})\Delta{p}div\delta{\bold{u}}dV
\end{equation}
\begin{equation} \label{lhs3}
D_{\delta{p}, \Delta\bold{u}}^2 \Pi(\bold{u}, p) = \int_{\Omega_0} J(\bold{u})div\Delta{\bold{u}}\delta{p}dV
\end{equation}
Since $\Pi$ is a first order function with respect to $p$, we have
\begin{equation} \label{lhs4}
D_{\delta{p}, \Delta{p}}^2 \Pi(\bold{u}, p) = 0
\end{equation}
Inserting Equation \ref{rhs1} to \ref{lhs4} into Equation \ref{linear} we can obtain a symmetric tangent stiffness matrix. Since $p$ is arbitrary for incompressible material, we need additional reference values for it to solve \ref{equilibrium}.

While for nearly incompressible material, the incompressibility condition is no longer strictly enforced. Recall Equation \ref{penalty} and \ref{pressure}, Equation \ref{rhs2} is relaxed to

\begin{equation} \label{relation}
D_{\delta{p}}\Pi(\bold{u}, p) = \int_{\Omega_0}\left(  \frac{dG(J(\bold{u}))}{dJ} - \frac{p}{\kappa} \right)\delta{p}dV = 0
\end{equation}
which reflects the fact that $p$ is not arbitrary but related to $\bold{u}$.  
Accordingly, the second variation on $p$ is no longer $0$. Equation \ref{lhs4} is modified as
\begin{equation} \label{lhs42}
D_{\delta{p}, \Delta{p}}^2 \Pi(\bold{u}, p) = - \int_{\Omega_0}\frac{1}{\kappa}\Delta{p}\delta{p}dV
\end{equation}
Equation \ref{lhs1} to \ref{lhs3} and Equation \ref{rhs1} remain the same. The linear equation is closed, we do not need additional information on $p$.
